# .github/workflows/collect_and_train.yml

name: Daily Collect and Weekly Train

on:
  schedule:
    # 1. ë§¤ì¼ KST ì˜¤ì „ 10ì‹œ (UTC 01:00)ì— ì–´ì œ ì‹œì¥ ê²°ê³¼ ìˆ˜ì§‘
    - cron: '0 1 * * *'
    # 2. ë§¤ì£¼ ì¼ìš”ì¼ KST ì˜¤ì „ 11ì‹œ (UTC 02:00)ì— ëª¨ë¸ ì¬í•™ìŠµ
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  collect-actuals:
    runs-on: ubuntu-latest
    # "collect-actuals" ì‘ì—…ì€ cron '0 1 * * *' (ë§¤ì¼) ì‹¤í–‰
    if: github.event.schedule == '0 1 * * *' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # collector.pyëŠ” yfinanceê°€ í•„ìš”í•¨

      - name: Run collector script
        run: python collector.py #

      - name: Commit and push database
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add database.db
          git diff --staged --quiet || (git commit -m "ğŸ“Š Update actual market data" && git push)

  train-model:
    runs-on: ubuntu-latest
    # "train-model" ì‘ì—…ì€ cron '0 2 * * 0' (ë§¤ì£¼ ì¼ìš”ì¼) ì‹¤í–‰
    if: github.event.schedule == '0 2 * * 0' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # trainer.pyëŠ” scikit-learn, joblib ë“±ì´ í•„ìš”í•¨

      - name: Run training script
        run: python trainer.py #

      - name: Commit and push new model
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add market_predictor.pkl
          git diff --staged --quiet || (git commit -m "ğŸ§  Update AI model" && git push)